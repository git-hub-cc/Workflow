<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车险案件录入 - 穗源保险公估一体化业务管理平台</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app-container">
    <!-- 侧边导航栏 -->
    <aside class="sidebar">
        <div class="sidebar-header">穗源保险公估</div>
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item active"><a href="dispatcher_task_query.html">案件管理</a></li>
            <li class="sidebar-nav-item"><a href="dispatcher_schedule_management.html">排班管理</a></li>
        </ul>
    </aside>

    <!-- 主内容区 -->
    <div class="main-wrapper">
        <!-- 顶部栏 -->
        <header class="header">
            <div class="header-left">
                <button id="hamburger-btn" class="hamburger-btn">☰</button>
            </div>
            <div class="user-profile">
                <div class="avatar" style="background-color: #E6A23C;">王</div>
                <span>王芳 (调度员)</span>
            </div>
        </header>

        <!-- 页面内容 -->
        <main class="main-content">
            <h1 class="page-title">车险案件录入</h1>

            <div class="card">
                <div class="card-header"><span>案件委托信息</span></div>
                <form id="case-entry-form" class="form-grid">
                    <!-- Row 1: 主案件号 -->
                    <div class="form-item col-span-full">
                        <label for="case-no">主案件号</label>
                        <div class="input-with-button">
                            <input type="text" id="case-no" value="" placeholder="输入保险公司主案件号后点击获取">
                            <button type="button" id="fetch-case-data-btn" class="btn btn-primary">获取信息</button>
                        </div>
                    </div>

                    <!-- START: 新增关联报案号区域 -->
                    <div class="form-item col-span-full">
                        <label for="associated-case-no">关联案件号 (可选)</label>
                        <div class="input-with-button">
                            <input type="text" id="associated-case-no" placeholder="输入关联号后按回车或点击添加">
                            <button type="button" id="add-associated-case-btn" class="btn btn-secondary">添加</button>
                        </div>
                        <div id="associated-case-list" class="tag-list">
                            <!-- 动态添加的关联报案号会显示在这里 -->
                        </div>
                    </div>
                    <!-- END: 新增关联报案号区域 -->

                    <!-- Row 2 -->
                    <div class="form-item">
                        <label for="insurer">承保方</label>
                        <select id="insurer">
                            <option>平安保险</option>
                            <option>人保财险</option>
                            <option>太平洋保险</option>
                            <option>其他</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label for="license-plate">车牌号</label>
                        <input type="text" id="license-plate" placeholder="点击获取信息后自动填充">
                    </div>

                    <!-- Row 3 -->
                    <div class="form-item">
                        <label for="reporter">报案人</label>
                        <input type="text" id="reporter" placeholder="点击获取信息后自动填充">
                    </div>
                    <div class="form-item">
                        <label for="reporter-phone">报案人电话</label>
                        <input type="text" id="reporter-phone" placeholder="点击获取信息后自动填充">
                    </div>

                    <!-- Row 4 -->
                    <div class="form-item">
                        <label for="incident-time">出险时间</label>
                        <input type="datetime-local" id="incident-time" placeholder="点击获取信息后自动填充">
                    </div>
                    <div class="form-item">
                        <label for="commission-time">委托时间</label>
                        <input type="datetime-local" id="commission-time" placeholder="点击获取信息后自动填充">
                    </div>

                    <!-- Row 5 -->
                    <div class="form-item col-span-full">
                        <label for="location">作业地点</label>
                        <div class="input-group">
                            <select class="city-select">
                                <option>选择省市区</option>
                                <option selected>广东省广州市天河区</option>
                            </select>
                            <input type="text" class="address-input" id="location" placeholder="手录详细地址">
                        </div>
                    </div>

                    <!-- START: 修改后的任务类型与模板选择 -->
                    <div class="form-item">
                        <label for="task-type">保司调派任务类型</label>
                        <select id="task-type">
                            <option>查勘+定损</option>
                            <option>人伤查勘</option>
                            <option>车物查勘</option>
                            <option>车物定损</option>
                        </select>
                    </div>
                    <!-- END: 修改后的任务类型与模板选择 -->

                    <div class="form-item">
                        <label for="dispatcher">调度员</label>
                        <input type="text" id="dispatcher" value="王芳 (按当前账号)" disabled>
                    </div>
                    <div class="form-item">
                        <label for="estimated-loss">估损金额 (元)</label>
                        <input type="number" id="estimated-loss" placeholder="0.00">
                    </div>


                </form>


            </div>

            <div class="card">
                <!-- 委托内容管理 -->
                <div class="assignment-task-group">
                    <div class="task-header"
                         style="display: flex; justify-content: space-between; align-items: center;">
                        <h4>委托内容管理</h4>
                        <div class="add-task-container">
                            <button id="add-task-btn" class="btn btn-secondary btn-sm">[+] 新增任务</button>
                            <ul id="add-task-menu" class="add-task-menu">
                                <li data-task-name="人伤查勘">人伤查勘</li>
                                <li data-task-name="车物查勘">车物查勘</li>
                                <li data-task-name="车物定损">车物定损</li>
                            </ul>
                        </div>
                    </div>
                    <ul id="task-list" class="dispatch-task-list">
                        <!-- 任务将根据上方信息获取后动态生成 -->
                    </ul>
                </div>

                <hr class="task-separator">

                <!-- 指派查勘员 -->
                <div class="assignment-task-group">
                    <div class="task-header">
                        <h4>将选中任务指派给</h4>
                    </div>
                    <ul class="surveyor-list" id="surveyor-assignment-list">
                        <li>
                            <div class="surveyor-avatar" style="background-color: #D6EFFF; color: #409EFF;">陈</div>
                            <div class="surveyor-info">
                                <div class="name">陈浩</div>
                                <div class="details"><span class="status-dot status-idle"></span>广州天河</div>
                            </div>
                            <button class="btn btn-primary assign-btn">指派</button>
                        </li>
                        <li>
                            <div class="surveyor-avatar" style="background-color: #E1F3D8; color: #67C23A;">刘</div>
                            <div class="surveyor-info">
                                <div class="name">刘洋</div>
                                <div class="details"><span class="status-dot status-idle"></span>广州白云</div>
                            </div>
                            <button class="btn btn-primary assign-btn">指派</button>
                        </li>
                        <li>
                            <div class="surveyor-avatar" style="background-color: #F8E8D5; color: #E6A23C;">吴</div>
                            <div class="surveyor-info">
                                <div class="name">吴静</div>
                                <div class="details"><span class="status-dot status-idle"></span>广州番禺</div>
                            </div>
                            <button class="btn btn-primary assign-btn">指派</button>
                        </li>
                        <li>
                            <div class="surveyor-avatar" style="background-color: #FDE2E2; color: #F56C6C;">李</div>
                            <div class="surveyor-info">
                                <div class="name">李强</div>
                                <div class="details"><span class="status-dot status-busy"></span>佛山顺德</div>
                            </div>
                            <button class="btn btn-primary assign-btn" disabled>指派</button>
                        </li>
                    </ul>
                </div>
                <!-- END: 新增委托任务指派模块 -->
                <!-- Row 8 -->
                <div class="form-item col-span-full">
                    <label for="remarks">备注</label>
                    <textarea id="remarks"></textarea>
                </div>
                <!-- Actions -->
                <div class="form-actions col-span-full">
                    <a href="dispatcher_task_query.html" class="btn btn-secondary">返回列表</a>
                    <button type="button" id="reset-btn" class="btn btn-secondary">重置</button>
                    <!-- START: 新增的确定按钮 -->
                    <button type="button" id="submit-btn" class="btn btn-primary">确定</button>
                    <!-- END: 新增的确定按钮 -->
                </div>
            </div>
        </main>
    </div>
</div>

<script src="demo_helper.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fetchBtn = document.getElementById('fetch-case-data-btn');
        const caseNoInput = document.getElementById('case-no');
        const resetBtn = document.getElementById('reset-btn');
        const submitBtn = document.getElementById('submit-btn'); // 获取新增的确定按钮
        const caseForm = document.getElementById('case-entry-form');
        const mainCard = document.querySelector('.card');

        // --- 关联报案号功能 JS ---
        const associatedInput = document.getElementById('associated-case-no');
        const addAssociatedBtn = document.getElementById('add-associated-case-btn');
        const associatedList = document.getElementById('associated-case-list');

        function addAssociatedCase(caseValue) {
            const value = caseValue.trim();
            if (value === '') return;

            const tag = document.createElement('div');
            tag.className = 'tag-item';
            tag.innerHTML = `<span>${value}</span><button type="button" class="tag-remove-btn">&times;</button>`;
            tag.querySelector('.tag-remove-btn').onclick = () => tag.remove();
            associatedList.appendChild(tag);
            associatedInput.value = '';
            associatedInput.focus();
        }

        addAssociatedBtn.addEventListener('click', () => addAssociatedCase(associatedInput.value));
        associatedInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addAssociatedCase(associatedInput.value);
            }
        });

        // --- 委托内容管理与指派 JS ---
        const taskList = document.getElementById('task-list');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addTaskMenu = document.getElementById('add-task-menu');

        /** 创建一个任务行 */
        function createTaskListRow(taskName) {
            const li = document.createElement('li');
            li.dataset.taskId = `new-${Date.now()}`;
            li.innerHTML = `
                <label class="task-item-label">
                    <input type="checkbox" class="task-checkbox">
                    <span class="task-name">${taskName}</span>
                </label>
                <span class="task-assignment-status status-tag status-info">待派单</span>
                <button class="delete-task-btn">&times;</button>
            `;
            return li;
        }

        /** 根据任务类型字符串填充任务列表 */
        function populateTasksByType(taskTypeStr) {
            taskList.innerHTML = ''; // 清空
            if (taskTypeStr.includes('查勘+定损')) {
                taskList.appendChild(createTaskListRow('车物查勘'));
                taskList.appendChild(createTaskListRow('车物定损'));
            } else if (taskTypeStr) {
                taskList.appendChild(createTaskListRow(taskTypeStr));
            }
        }

        // --- 获取案件信息按钮逻辑 ---
        fetchBtn.addEventListener('click', function () {
            if (!caseNoInput.value) {
                showModal('操作提示', '请输入案件号 / 报案号！', 'warning');
                return;
            }
            this.textContent = '获取中...';
            this.disabled = true;

            setTimeout(() => {
                const mockData = {
                    licensePlate: '粤A·88888',
                    reporter: '王先生',
                    reporterPhone: '13800138000',
                    incidentTime: '2024-05-20T09:15',
                    commissionTime: '2024-05-20T09:45',
                    location: '黄埔大道西668号 赛马场内',
                    estimatedLoss: 4500,
                    insurer: '平安保险',
                    taskType: '查勘+定损',
                    associatedCases: ['PABXGZ00124', 'PABXGZ00125']
                };

                // 填充表单
                document.getElementById('license-plate').value = mockData.licensePlate;
                document.getElementById('reporter').value = mockData.reporter;
                // ... (omitting other fields for brevity)
                document.getElementById('task-type').value = mockData.taskType;

                // 填充关联案件
                associatedList.innerHTML = '';
                mockData.associatedCases.forEach(caseNum => addAssociatedCase(caseNum));

                // 智能填充委托任务
                populateTasksByType(mockData.taskType);

                this.textContent = '获取信息';
                this.disabled = false;
                showModal('成功', '案件信息已成功获取并填充！', 'success');
            }, 800);
        });

        // --- 重置按钮逻辑 ---
        resetBtn.addEventListener('click', function () {
            caseForm.reset();
            associatedList.innerHTML = '';
            taskList.innerHTML = ''; // 同时清空任务列表
            document.getElementById('dispatcher').value = "王芳 (按当前账号)";
        });

        // START: 新增确定按钮的逻辑
        submitBtn.addEventListener('click', function () {
            if (!caseNoInput.value) {
                showModal('操作提示', '请先输入或获取案件信息，再进行保存。', 'warning');
                return;
            }
            // 检查是否所有任务都已指派
            const pendingTasks = taskList.querySelectorAll('.task-assignment-status.status-info');
            if (pendingTasks.length > 0) {
                showModal('操作提示', `还有 ${pendingTasks.length} 个任务未指派，请指派后再提交。`, 'warning');
                return;
            }
            // 模拟保存操作
            showModal('保存成功', `案件 <strong>${caseNoInput.value}</strong> 的信息已成功保存。`, 'success');
        });
        // END: 新增确定按钮的逻辑

        // --- 委托任务指派模块事件监听 ---
        if (taskList && mainCard && addTaskBtn && addTaskMenu) {
            addTaskBtn.addEventListener('click', e => {
                e.stopPropagation();
                addTaskMenu.classList.toggle('show');
            });
            window.addEventListener('click', () => addTaskMenu.classList.contains('show') && addTaskMenu.classList.remove('show'));

            addTaskMenu.addEventListener('click', e => {
                if (e.target.tagName === 'LI') {
                    taskList.appendChild(createTaskListRow(e.target.dataset.taskName));
                    addTaskMenu.classList.remove('show');
                }
            });

            mainCard.addEventListener('click', function (e) {
                if (e.target.classList.contains('delete-task-btn')) {
                    e.target.closest('li').remove();
                }

                if (e.target.classList.contains('assign-btn')) {
                    if (!caseNoInput.value) {
                        showModal('操作提示', '请先输入或获取案件信息，再进行指派。', 'warning');
                        return;
                    }
                    const surveyorName = e.target.closest('li').querySelector('.surveyor-info .name').textContent;
                    const selectedTasks = taskList.querySelectorAll('.task-checkbox:checked:not([disabled])');
                    if (selectedTasks.length === 0) {
                        showModal('操作提示', '请至少勾选一个“待派单”的任务。', 'warning');
                        return;
                    }

                    let assignedTaskNames = [];
                    selectedTasks.forEach(checkbox => {
                        const taskItem = checkbox.closest('li');
                        const statusSpan = taskItem.querySelector('.task-assignment-status');
                        taskItem.querySelector('.task-name').style.textDecoration = 'line-through';
                        statusSpan.textContent = `已指派: ${surveyorName}`;
                        statusSpan.className = 'task-assignment-status status-tag status-success';
                        checkbox.checked = false;
                        checkbox.disabled = true;
                        assignedTaskNames.push(taskItem.querySelector('.task-name').textContent);
                    });

                    if (assignedTaskNames.length > 0) {
                        const taskListHtml = assignedTaskNames.map(name => `<li>${name}</li>`).join('');
                        showModal('保存并派单成功', `案件 <strong>${caseNoInput.value}</strong> 已保存，并将以下任务指派给 <strong>${surveyorName}</strong>：<ul style="text-align:left; padding-left:20px; margin-top:10px;">${taskListHtml}</ul>`, 'success');
                    }
                }
            });
        }
    });
</script>
</body>
</html>