### 1. 项目概述

本项目是一个基于 **Spring Boot** 和 **Camunda BPM** 构建的、高度可配置的业务流程管理（BPM）平台。它的核心目标是让业务人员能够通过 **低代码/无代码** 的方式，快速设计表单、搭建审批流程，并将其集成到统一的门户中。

#### 1.1. 核心技术栈

-   **核心框架**: Spring Boot 3+
-   **工作流引擎**: Camunda BPM 7+
-   **安全与认证**: Spring Security, JWT (JSON Web Tokens)
-   **数据持久化**: Spring Data JPA / Hibernate
-   **数据库**: H2 (开发环境), 可轻松切换至 MySQL/PostgreSQL
-   **日志**: SLF4J, Logback
-   **AOP**: Spring AOP (用于操作日志等横切关注点)
-   **其他**: Lombok, Jackson, Apache POI (用于 Word 导入)

### 2. 核心概念

要理解本项目，必须先掌握以下几个核心概念：

1.  **动态表单 (Dynamic Forms)**
    *   **是什么**: 表单的结构（包含哪些字段、字段类型、布局）不是在代码中写死的，而是以 JSON 格式存储在数据库中 (`form_definition` 表)。
    *   **如何工作**: 前端根据这个 JSON Schema 动态渲染出表单页面。用户提交的数据也以 JSON 格式存入 `form_submission` 表。
    *   **关键文件**: `FormDefinition.java`, `FormSubmission.java`, `FormController.java`, `FormService.java`

2.  **工作流模板 (Workflow Template)**
    *   **是什么**: 每个动态表单都可以关联一个工作流。这个工作流的设计图（BPMN 2.0 格式的 XML）被存储在 `workflow_template` 表中。
    *   **如何工作**: 当用户提交一个关联了流程的表单时，系统会根据这份 BPMN XML 启动一个**流程实例 (Process Instance)**。
    *   **关键文件**: `WorkflowTemplate.java`, `WorkflowController.java`, `WorkflowService.java`

3.  **组织架构 (Organization Structure)**
    *   **是什么**: 系统包含一个完整的组织架构模型，包括**用户 (User)**、**角色 (Role)**、**用户组 (UserGroup)** 和层级化的**部门 (Department)**。
    *   **如何工作**: 流程中的审批人可以动态指定，例如“发起人的直接上级”或“财务部的审批角色”。这个模型是实现权限控制和流程流转的基础。
    *   **关键文件**: `User.java`, `Role.java`, `Department.java`, `AdminService.java` (用于管理), `FindManagerDelegate.java` (用于在流程中查找上级)

4.  **动态菜单与数据权限 (Dynamic Menu & Data Scopes)**
    *   **是什么**: 系统的左侧菜单栏不是固定的，而是根据用户的**角色**动态生成的。每个菜单项还可以配置**数据可见范围 (DataScope)**。
    *   **如何工作**: 用户登录后，`MenuService` 会根据其角色构建出专属的菜单树。当用户通过菜单访问数据列表时，`FormService` 会根据菜单配置的 `DataScope` (例如：仅看本部门、仅看自己) 来过滤数据。
    *   **关键文件**: `Menu.java`, `DataScope.java`, `MenuService.java`, `FormService.java` (其中的 `applyDataScope` 方法)

### 3. 架构分层

项目遵循经典的三层架构，并增加了专门的配置和切面层。



#### 3.1. `controller` - 接口层
*   **职责**: 作为应用的 HTTP 入口，负责接收前端请求、验证基本参数、调用 Service 层处理业务，并返回统一格式的 JSON 数据。
*   **特点**:
    *   使用 `@RestController` 注解。
    *   通过 `@PreAuthorize` 进行精细的接口权限控制。
    *   所有 API 路径都以 `/api` 开头。
*   **示例**:
    *   `AuthController.java`: 处理用户登录。
    *   `AdminController.java`: 包含所有管理员功能接口（用户管理、角色管理、部门管理等）。
    *   `WorkflowController.java`: 与流程设计、发起、历史记录相关的接口。
    *   `TaskController.java`: 处理用户的待办任务。

#### 3.2. `service` - 业务逻辑层
*   **职责**: 实现所有核心业务逻辑。这是项目最复杂、最核心的部分。
*   **特点**:
    *   使用 `@Service` 注解。
    *   通过 `@Transactional` 管理数据库事务。
    *   封装了对 Camunda 引擎 API 和 Repository 的调用。
*   **关键服务**:
    *   `WorkflowService.java`: 封装了与 Camunda 引擎的所有交互，如部署流程、启动实例、完成任务等。
    *   `FormService.java`: 负责表单定义和提交数据的 CRUD，以及复杂的数据权限过滤查询。
    *   `AdminService.java`: 实现了所有后台管理功能的业务逻辑。
    *   `*Delegate.java` (如 `FindManagerDelegate.java`, `ArchiveProcessDelegate.java`): 特殊的服务，实现了 Camunda 的 `JavaDelegate` 接口，可以在 BPMN 流程图中作为“服务任务”节点被引擎直接调用，用于执行自定义 Java 逻辑。

#### 3.3. `repository` - 数据访问层
*   **职责**: 定义与数据库交互的接口，负责数据的持久化和查询。
*   **特点**:
    *   使用 `@Repository` 注解。
    *   接口继承 `JpaRepository`，自动获得标准的 CRUD 功能。
    *   对于复杂查询，使用 `JpaSpecificationExecutor` 或 `@Query` 注解。
*   **示例**: `UserRepository.java`, `FormSubmissionRepository.java`, `MenuRepository.java` 等。

#### 3.4. `domain` - 领域模型层
*   **职责**: 定义应用的核心业务对象，并映射到数据库表结构。
*   **特点**:
    *   都是 POJO (Plain Old Java Object)。
    *   使用 `@Entity` 注解标记为 JPA 实体。
    *   通过 `@ManyToOne`, `@OneToMany`, `@ManyToMany` 等注解定义实体间的关系。
*   **核心实体**: `User`, `Department`, `Role`, `Menu`, `FormDefinition`, `FormSubmission`, `WorkflowTemplate`, `WorkflowInstance`.

#### 3.5. `dto` - 数据传输对象层
*   **职责**: 定义用于在各层之间，特别是 Controller 和前端之间传输数据的对象。
*   **特点**:
    *   避免直接暴露 `domain` 实体，实现内外模型分离。
    *   可以根据 API 的需要对数据进行裁剪和重组。
*   **示例**: `UserDto`, `MenuDto`, `TaskDto`, `AuthResponse`.

#### 3.6. `config` - 配置层
*   **职责**: 集中管理应用的配置，特别是安全、过滤器等。
*   **关键配置**:
    *   `SecurityConfig.java`: 配置 Spring Security，定义哪些 URL 路径需要认证、哪些需要特定角色。
    *   `JwtAuthFilter.java`: 一个 `OncePerRequestFilter`，在每个请求到达前拦截，校验请求头中的 JWT，如果有效，则将用户信息设置到 Spring Security 上下文中。

#### 3.7. `aop` & `exception` & `listener` - 横切关注点
*   **`aop`**:
    *   `OperationLogAspect.java`: 一个 AOP 切面，通过自定义注解 `@LogOperation`，自动拦截并记录用户的关键操作（如创建用户、删除角色）到数据库。
*   **`exception`**:
    *   `GlobalExceptionHandler.java`: 全局异常处理器。捕获 Controller 层抛出的所有异常，并返回统一、规范的 `ErrorResponse` JSON 对象，极大提升了前端错误处理的便利性。
*   **`listener`**:
    *   `TaskAssignmentListener.java`: Camunda 任务监听器，当一个新任务被创建时触发，调用 `NotificationService` 发送邮件通知。
    *   `AuthenticationFailureListener.java`: Spring Security 事件监听器，监听登录失败事件并记录日志。

### 4. 关键流程追踪：发起一个审批

为了将以上概念串联起来，我们追踪一次完整的“请假申请”流程：

1.  **用户操作**: 用户在前端打开“请假申请”菜单，填写表单（姓名、天数、原因），点击“提交”。
2.  **前端请求**: 前端向后端发送 `POST /api/forms/{formId}/submissions` 请求，`formId` 对应“请假申请”表单，请求体中包含表单数据 JSON 和附件 ID 列表。
3.  **Controller 层**: `FormController.java` 的 `createFormSubmission` 方法接收到请求。
4.  **Service 层 (表单)**: `FormService.java` 的 `createFormSubmission` 方法被调用。
    *   它创建一个 `FormSubmission` 实体，将表单数据 JSON 存入。
    *   它更新 `FileAttachment` 记录，将其与新创建的 `FormSubmission` 关联起来。
    *   将 `FormSubmission` 保存到数据库。
    *   **关键一步**: 调用 `workflowService.startWorkflow(savedSubmission)`。
5.  **Service 层 (工作流)**: `WorkflowService.java` 的 `startWorkflow` 方法被调用。
    *   根据 `submission` 的 `formId` 找到关联的 `WorkflowTemplate`。
    *   从模板中获取流程定义 Key (e.g., `leave_request_process`)。
    *   准备流程变量，如 `submitterId`, `formSubmissionId`，并从数据库中查询发起人的上级 `managerId`。
    *   调用 Camunda 的 `runtimeService.startProcessInstanceByKey(...)`，正式启动一个流程实例。
6.  **Camunda 引擎**:
    *   引擎根据 BPMN 图，从“开始”节点流转。
    *   假设下一节点是“部门经理审批”，这是一个用户任务 (User Task)，其审批人被设置为 `${managerId}`。
    *   引擎根据流程变量中的 `managerId`，为该用户创建一个新的**待办任务**。
    *   在创建任务时，`TaskAssignmentListener` 被触发，异步地向部门经理发送一封邮件通知。
7.  **返回响应**: 流程启动后，`FormService` 将新创建的 `FormSubmission` 信息包装成 `FormSubmissionResponse` DTO 返回给前端。前端提示“提交成功”。
8.  **后续**: 部门经理登录系统，调用 `GET /api/tasks/pending` 接口，就能看到这条待办任务。

### 5. 如何开始

1.  **环境搭建**: 确保已安装 JDK 17+ 和 Maven。配置好 `application.properties` 中的数据库连接（默认为 H2，无需配置）。
2.  **启动应用**: 直接运行 `WorkflowApplication.java` 的 `main` 方法。
3.  **访问 Camunda Cockpit**: 启动后，访问 `http://localhost:8080/camunda/app/cockpit/` 可以看到 Camunda 的管理后台，查看已部署的流程和运行中的实例。
4.  **初始化数据**: `WorkflowApplication.java` 中的 `CommandLineRunner` 会在启动时自动创建演示用户、角色和部门。
    *   管理员: `admin` / `admin`
    *   普通员工: `user001` (张三) / `password`
    *   经理: `manager001` (李四) / `password`
5.  **调试代码**: 从 `controller` 层开始，设置断点，使用 Postman 或类似工具调用 API，跟踪代码执行流程。重点关注 `WorkflowService` 和 `FormService`。

希望这份文档能帮助您快速融入项目！